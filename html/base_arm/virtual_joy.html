<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Virtual Joy + Joint UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      display: flex;
      flex-direction: column;
    }
    #joy_zone {
      flex: 1;
      width: 100%;
      background: rgba(200, 200, 255, 0.1);
      position: relative;
    }
    #sliders {
      padding: 10px;
      background: #f0f0f0;
    }
    label {
      display: inline-block;
      width: 80px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/roslib@1/build/roslib.min.js"></script>
  <script src="nipplejs.js"></script>
</head>

<body>
  <div id="joy_zone"></div>
  <div id="sliders"></div>

  <script>
    // === ROS接続 ===
    const params = new URLSearchParams(window.location.search);
    const wsaddr = params.get("wsaddr") || location.hostname;
    const wsport = params.get("wsport") || (location.protocol === "https:" ? "8443" : "9090");
    const ssl = params.get("ssl") === "1";

    const ros = new ROSLIB.Ros({
      url: (ssl ? "wss://" : "ws://") + wsaddr + ":" + wsport
    });

    // === cmd_vel Publisher ===
    const twistTopic = new ROSLIB.Topic({
      ros: ros,
      name: "/cmd_vel",
      messageType: "geometry_msgs/Twist"
    });

    // === joint_controller Publisher (JointTrajectory) ===
    const jointPublisher = new ROSLIB.Topic({
      ros: ros,
      name: "/Frame_Short/joint_controller/command",
      messageType: "trajectory_msgs/JointTrajectory"
    });

    const jointNames = ["joint1", "joint2", "joint3", "joint4", "joint0"];
    const sliderValues = new Array(jointNames.length).fill(0.0);
    const slidersDiv = document.getElementById("sliders");

    function publishJointValues() {
      const msg = new ROSLIB.Message({
        header: {
          seq: 0,
          stamp: { secs: 0, nsecs: 0 },
          frame_id: ""
        },
        joint_names: jointNames,
        points: [
          {
            positions: sliderValues,
            velocities: [],
            accelerations: [],
            effort: [],
            time_from_start: {
              secs: 5,
              nsecs: 0
            }
          }
        ]
      });
      jointPublisher.publish(msg);
    }

    // === スライダーUI生成 ===
    for (let i = 0; i < jointNames.length; i++) {
      const label = document.createElement("label");
      label.innerText = `${jointNames[i]}: `;

      const slider = document.createElement("input");
      slider.type = "range";
      slider.min = "-3.14";
      slider.max = "3.14";
      slider.step = "0.01";
      slider.value = "0.0";
      slider.oninput = (e) => {
        sliderValues[i] = parseFloat(e.target.value);
        publishJointValues();
      };

      slidersDiv.appendChild(label);
      slidersDiv.appendChild(slider);
      slidersDiv.appendChild(document.createElement("br"));
    }

    // === ジョイスティック処理 ===
    const half_width = window.innerWidth / 2;
    let current_right = -1, current_left = -1;
    let cur_x_left = 0.0, cur_y_left = 0.0;
    let cur_x_right = 0.0;

    function publishTwist() {
      const twist = new ROSLIB.Message({
        linear: { x: cur_y_left, y: cur_x_left, z: 0.0 },
        angular: { x: 0.0, y: 0.0, z: cur_x_right }
      });
      twistTopic.publish(twist);
    }

    nipplejs.create({
      zone: document.getElementById('joy_zone'),
      size: 160,
      mode: 'dynamic',
      multitouch: true,
      color: 'blue'
    })
    .on('start', (evt, data) => {
      if (data.position.x > half_width) {
        current_right = data.identifier;
      } else {
        current_left = data.identifier;
      }
    })
    .on('end', (evt, data) => {
      if (data.identifier === current_right) {
        current_right = -1;
        cur_x_right = 0.0;
      } else if (data.identifier === current_left) {
        current_left = -1;
        cur_x_left = 0.0;
        cur_y_left = 0.0;
      }
      publishTwist();
    })
    .on('move', (evt, data) => {
      if (data.identifier === current_right) {
        cur_x_right = data.vector.x;
      } else if (data.identifier === current_left) {
        cur_x_left = data.vector.x;
        cur_y_left = data.vector.y;
      }
      publishTwist();
    });
  </script>
</body>
</html>
